<%- model_class = Envbooking -%>

<% content_for :vis_entry_point do %>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.3.0/vis.min.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.3.0/vis.min.css" rel="stylesheet" type="text/css" />

  <script id="item-template" type="text/x-handlebars-template">
    {{name}}
  </script>

  <script type="text/javascript">
    $(function(){
      var source = document.getElementById('item-template').innerHTML;
      var template = Handlebars.compile(source);

      var container=document.getElementById('visualization');
      var groups = new vis.DataSet();

      <% @envs.each do |env| %>
        groups.add({id:<%= env.id %>, content:'<%= env.name %>'});
      <% end %>

      var items = new vis.DataSet();

      <% @envbookings.each do |booking| %>
        <% days_left = (booking.end_date - Date.today).to_i %>

        var title = "App : <%= App.find_by_id(booking.app_id).name %>, \n\
  Project : <%= Project.find_by_id(booking.project_id).name %>, \n\
  Start : <%= booking.start_date.strftime('%d/%m/%Y') %>, \n\
  End : <%= booking.end_date.strftime('%d/%m/%Y') %> \n\
  Remaining: <%= days_left %> days"

        items.add({
          id: <%= booking.id %>,
          type: 'range',
          start: '<%= booking.start_date.to_time.iso8601 %>',
          end: '<%= booking.end_date.to_time.iso8601 %>',
          user: '<%= User.find_by_id(booking.user_id).email %>',
          name: '<%= User.find_by_id(booking.user_id).name %>',
          project: '<%= Project.find_by_id(booking.project_id).name %>',
          app: '<%= App.find_by_id(booking.app_id).name %>',
          group: <%= booking.env_id %>,
          title: title,
          style: 'background-color: <%= App.find_by_id(booking.app_id).color %>'
        });
      <% end %>

      var options = {
        clickToUse: true,
        min: '<%= @min_date %>',
        max: '<%= @max_date %>',
        template: template,
      <% if current_user.try(:admin?) %>
        editable: true,
      <% else %>
        editable: false,
      <% end %>
        onRemove: function(item, callback) {
          var r = confirm("Are you sure?");
          if(r == true) {
            $.ajax({
              url: '/envbookings/delete_booking',
              type: 'post',
              data: { envbooking: JSON.stringify(item)}
            });
            callback(item);
          }
          else {
            callback(null);
          }
        },
        onMove: function(item, callback) {
          $.ajax({
            url: '/envbookings/update_booking',
            type: 'post',
            data: { envbooking: JSON.stringify(item)}
          });
          callback(item);
        },
        type: 'range'
      };
      var timeline = new vis.Timeline(container, items, groups, options);
    });
  </script>

<% end %>

<% content_for :timeline_divs do %>
  <div class="panel panel-default ">
    <div class="panel-heading">
      <h1>Bookings</h1>
      <table class="well table-responsive">
        <tbody>
          <tr>
          <% @apps.each do |a| %>
              <td>
                <div class="color-box" style="background-color: <%= a.color %>;"></div>
              </td>
              <td>
                <%= a.name %>
              </td>
              <td>&nbsp;</td>
          <% end %>
        </tbody>
      </table>
    </div>
    <div class="panel-body">
      <div id="visualization"></div>
    </div>
    <div class="panel-footer">
    </div>
  </div>

<% end %>
